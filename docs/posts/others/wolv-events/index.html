<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-10-11">

<title>Building a simple university event recommender – Emilio Cantu-Cervini</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-H4ZD13L2K2"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-H4ZD13L2K2', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<meta name="quarto:status" content="draft">


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/index.html"> 
<span class="menu-text">posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#embedding-events" id="toc-embedding-events" class="nav-link" data-scroll-target="#embedding-events">Embedding events</a></li>
  <li><a href="#knn-recommender" id="toc-knn-recommender" class="nav-link" data-scroll-target="#knn-recommender">KNN recommender</a></li>
  <li><a href="#interest-embeddings" id="toc-interest-embeddings" class="nav-link" data-scroll-target="#interest-embeddings">Interest embeddings</a></li>
  <li><a href="#tuning" id="toc-tuning" class="nav-link" data-scroll-target="#tuning">Tuning</a>
  <ul class="collapse">
  <li><a href="#tuning-1" id="toc-tuning-1" class="nav-link" data-scroll-target="#tuning-1">Tuning</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a></li>
  <li><a href="#a-lot-of-room" id="toc-a-lot-of-room" class="nav-link" data-scroll-target="#a-lot-of-room">A lot of room</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/emiliocantuc/emiliocantuc.github.io/blob/main/posts/others/wolv-events/index.ipynb" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div><div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://mywolverine.events"><i class="bi bi-link-45deg"></i>The site</a></li></ul></div><div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/emiliocantuc/wolverine-events"><i class="bi bi-github"></i>Code</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building a simple university event recommender</h1>
<p class="subtitle lead">and using LLMs to tune it</p>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 11, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">March 12, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>I am currently a grad student at the University of Michigan and like to attend seminars, lectures, and social events when I can. However, I often attend the same weekly seminars because sifting through all events (about 400/week on avgerage) to find ones that interest me is very time-consuming. Last semester, I tried feeding the events to ChatGPT and <a href="https://emiliocantuc.github.io/umich-events-gpt/">asking for recommendations</a>, but they were not great.</p>
<p>So, given it’s break, I want to hack together a simple recommender system to do a better job. The goal is to get to an MVP that other students can use this weekend and iterate on it during the semester. Let’s see what we can come up with.</p>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>I want to keep the recommender as simple, hackable, and low-maintinance as possible. We’ll start with content-based filtering, where users are recommended similar events to ones they have previously enjoyed. To do so, we need a way for users to give feedback on events and a way of determining how similar two events are.</p>
<p>For feedback, we can allow users to downvote, upvote, and log if they add an event to their calendar.</p>
<p>To measure similarity we’ll represent our events as strings, obtain their <a href="https://towardsdatascience.com/neural-network-embeddings-explained-4d028e6f0526">embeddings</a>, and use take cosine distance between them. To avoid tuning and hosting our own model, we’ll turn to OpenAI’s embedding <a href="https://platform.openai.com/docs/guides/embeddings">API</a>.</p>
<p>Because I’d like to implement changes quickly and don’t expect more than a handful of users, the backend will be a simple Pyton-Flask-SQLite CRUD app.As to the data, the university’s event page, <a href="https://events.umich.edu/">Happening @ Michigan</a>, is great. It provides openly available endpoints to fetch daily, weekly, and monthly events with all of their details in JSON format. Great! No scrapping is necessary. We can simply run a cronjob to fetch the events of the day or week to keep the system up-to-date <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
</section>
<section id="embedding-events" class="level2">
<h2 class="anchored" data-anchor-id="embedding-events">Embedding events</h2>
<p>Traditionally, one of the biggest challenges in recommender systems was coming up with vector representations of the items (movies, products, events, etc.) such that distances between are semantically meaningful. Luckily, it’s now very easy and convenient to throw items to a neural network and get such embeddings.</p>
<p>First, let’s take a look at three events and how we might represent their most relevant data fields as strings:</p>
<div id="2dd99dd2" class="cell">
<details class="code-fold">
<summary>Stringify event</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>day_of_week <span class="op">=</span> <span class="kw">lambda</span> datetime_str: datetime.strptime(datetime_str, <span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">T%H%M%S'</span>).strftime(<span class="st">'%A'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>gget <span class="op">=</span> <span class="kw">lambda</span> e, k, v: e.get(k, <span class="va">None</span>) <span class="cf">if</span> e.get(k, <span class="va">None</span>) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> v</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stringify_event(e, desc_len<span class="op">=</span><span class="dv">800</span>):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    limit <span class="op">=</span> <span class="kw">lambda</span> s, n: s <span class="cf">if</span> <span class="bu">len</span>(s) <span class="op">&lt;</span> n <span class="cf">else</span> s[:n<span class="op">-</span><span class="dv">3</span>] <span class="op">+</span> <span class="st">'...'</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    sponsors <span class="op">=</span> [gget(s, <span class="st">'group_name'</span>, <span class="st">''</span>) <span class="cf">for</span> s <span class="kw">in</span> gget(e, <span class="st">'sponsors'</span>, {})]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    maize_group <span class="op">=</span> e.get(<span class="st">'maizepages_import'</span>, {}).get(<span class="st">'maizepages_group_name'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> maize_group: sponsors.append(maize_group)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    o <span class="op">=</span> [</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>e[<span class="st">'event_type'</span>]<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>limit(gget(e, <span class="st">'combined_title'</span>, <span class="st">''</span>), <span class="dv">200</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>limit(gget(e, <span class="st">'description'</span>, <span class="st">''</span>), desc_len)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Where:</span><span class="sc">{</span>e[<span class="st">'location_name'</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="er">        f'When:{day_of_week(e['datetime_start'])} {e['time_start'].split(':')[0]}',</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sponsors: o.append(<span class="ss">f"Sponsors:</span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(sponsors)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d2a0f811" class="cell" data-execution_count="3">
<div class="cell-output cell-output-stdout">
<pre><code>==================================================
Exhibition:Sea Monsters
The film follows a curious and adventurous Dolichorhynchops – familiarly known as a ‘dolly’ – as she travels through the most dangerous oceans in history. Along the way, she encounters long-necked plesiosaurs, giant turtles, enormous fish, fierce sharks, and the most dangerous sea monster of all– the mosasaur.
Where:Museum of Natural History
When:Sunday 12
Sponsors:Planetarium &amp; Dome Theater at the Museum of Natural History
==================================================
Exercise / Fitness:Chair Aerobics
Lifetime Fitness classes are offered at Briarwood Mall in the JCPenney wing. No experience necessary. Classes are specifically designed for older adults, however, everyone is welcome. LTF classes are free, however, please consider making a $2/person per class donation as our classes are funded strictly through donations. No registration is necessary, simply attend when it fits your schedule. Chair Aerobics classes are carefully structured to include a warm-up, a pre-aerobic stretch, sitting and standing aerobics, strength training, a cooldown, and a final stretch.
Where:100 Briarwood Circle, Ann Arbor
When:Wednesday 09
Sponsors:Kinesiology Community Programs
==================================================
Tours:Coral Reef Tank Visit
Join Professor Jim Bardwell for a peek behind the scenes at his large coral reef tank featuring many species of coral, anemone, and fish. Explore reef ecology and, if you're lucky, get a glimpse of a reclusive octopus!  30 minutes, limit 12 people. This program takes place in the research area of the Biological Sciences Building and is recommended for ages 6 and up.
Space is available first come, first served. Sign up and meet at the Welcome desk.
Where:Museum of Natural History
When:Wednesday 12
Sponsors:Museum of Natural History</code></pre>
</div>
</div>
<p>Note that we only include the day of the week and the start hour in the date to make it easier for the text model to make sense of. For now, we’ll use OpenAI’s <code>text-embedding-3-small</code> model, but we can try others later.</p>
<p>We now have a normalized 1536-dimentional vector representing each event and can use dot products to determine similarity. For example, for the events above we have:</p>
<div id="8527529d" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(E[ixs] <span class="op">@</span> E[ixs].T)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>array([1.00000009, 0.09336403, 0.61303273])</code></pre>
</div>
</div>
<p>which makes sense since the first event is most similar to itself and then to the last event (which is also “sea themed”).</p>
<p>Before moving on, we should visualize the embeddings to make sure they are not collapsed.</p>
<div id="0c42758b" class="cell" data-execution_count="5">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
<figcaption>The first two principal components have some structure (example events from above displayed in red). Also observe that almost all of the variance can be explained by the first 500/1535 components.</figcaption>
</figure>
</div>
</div>
</div>
<div id="a4f10a06" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
<figcaption>Another sanity check:&nbsp;the cosine similarities are nicely spread out and not clustered around zero, unlike random normal vectors.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="knn-recommender" class="level2">
<h2 class="anchored" data-anchor-id="knn-recommender">KNN recommender</h2>
<p>If we encode downvotes as <code>-1</code>, upvotes as <code>1</code>, and “adds to calendar” as <code>2</code>, we could implement a very simple recommender. Given a user and a new event, look up the event’s k-nearest neighbors (using embeddings and dot products) with ratings by the user and return the average rating. This average rating can be considered the estimated rating the user would give to the new event. Repeat for each new event and return events with the highest predicted ratings.</p>
<p>This system would be fairly simple to spin up, and we could even keep the KNN lookup constant by using approximate methods like those provided in <a href="https://github.com/facebookresearch/faiss"><code>faiss</code></a> or any of the many vector databases.</p>
<p>However, we have to keep around a growing list of past events (at least their embeddings) and user ratings. To avoid running out of a cheap VM’s disk space (being very, very optimistic about user count), we could prune the oldest ratings once in a while or come up with some other simple scheme. But I wanted to try something else out.</p>
</section>
<section id="interest-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="interest-embeddings">Interest embeddings</h2>
<p>What if we maintain a single embedding per user that represents their interests? This coud be as simple as the weighted average of all events the user has interacted with. To avoid storing all past embeddings and allow for changing preferences, we can use an <a href="https://en.wikipedia.org/wiki/Exponential_smoothing#Double_exponential_smoothing_(Holt_linear)">exponentially moving average</a>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>usr_emb <span class="op">=</span> (alpha <span class="op">*</span> usr_emb) <span class="op">+</span> (<span class="dv">1</span><span class="op">-</span>alpha) <span class="op">*</span> w <span class="op">*</span> event_emb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>w</code> is the weight we give to the embedding of the event the user interacted with (<code>event_emb</code>) and <code>alpha</code> is tuneable parameter. This method is purely geometric: we move our interest embedding towards (<code>w &gt; 0</code>) events we like and away from (<code>w &lt; 0</code>) those we dislike.</p>
<p>While straightforward, this method has a few immediate drawbacks:</p>
<ul>
<li><p><strong>Preference dilution:</strong> we are blending all user interests into a single vector, potentially losing the multi-faceted nature of preferences. If a user has diverse interests, the averaged embedding could become less meaningful. Strong but infrequent interests will get washed out by more frequent but less important interactions.</p></li>
<li><p><strong>Param sensitivity:</strong> The <code>alpha</code> parameter is critical but could be difficult to tune. Too high and system is slow to adapt to changing preferences. Too low and system “forgets” long-term interests too quickly.</p></li>
<li><p><strong>Outlier sensitivity:</strong> One-off interactions could disproportionately shift interest embeddings.</p></li>
</ul>
<p>Along with the usual <a href="https://en.wikipedia.org/wiki/Cold_start_(recommender_systems)">cold-start</a>, explanability, and other traditional recommerder challanges.</p>
<p>To alliviate preference dilution and the cold-start problem, we can let users manually input a list of interests, embed and use them along with <code>usr_emb</code> to make recommendations.</p>
<div id="c3f57584" class="cell" data-execution_count="67">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_usr_emb(size <span class="op">=</span> E.shape[<span class="dv">1</span>]):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    emb <span class="op">=</span> np.random.normal(size <span class="op">=</span> size)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> emb <span class="op">/</span> np.linalg.norm(emb)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, usr_id, init_usr_emb_fn <span class="op">=</span> init_usr_emb):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.usr_id <span class="op">=</span> usr_id</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.usr_emb <span class="op">=</span> init_usr_emb_fn()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.interests <span class="op">=</span> {}</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_interests(<span class="va">self</span>, interests, interest_embs <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(interests, <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">isinstance</span>(interests[<span class="dv">0</span>], <span class="bu">str</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> interest_embs <span class="kw">is</span> <span class="va">None</span>: interest_emb <span class="op">=</span> get_embedding(interests)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, e <span class="kw">in</span> <span class="bu">zip</span>(interests, interest_emb): <span class="va">self</span>.interests[i] <span class="op">=</span> e</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Recommender:</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, events, event_embs, vote_EMA_alpha, interest_weight, mmr_relevance_lambda, dedup_threshold <span class="op">=</span> <span class="fl">0.99</span>):</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.events <span class="op">=</span> events</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.event_embs <span class="op">=</span> event_embs</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vote_EMA_alpha <span class="op">=</span> vote_EMA_alpha</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.interest_weight <span class="op">=</span> interest_weight</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mmr_relevance_lambda <span class="op">=</span> mmr_relevance_lambda</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dedup_threshold <span class="op">=</span> dedup_threshold</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> recommend(<span class="va">self</span>, user, n):</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate similarities</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        event_event_sims <span class="op">=</span> <span class="va">self</span>.event_embs <span class="op">@</span> <span class="va">self</span>.event_embs.T</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        usr_event_sims <span class="op">=</span> (user.usr_emb[<span class="va">None</span>, :] <span class="op">@</span> <span class="va">self</span>.event_embs.T).flatten()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For every event, the distance to the closest user interest</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        interest_event_max_sims <span class="op">=</span> np.zeros_like(usr_event_sims)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> user.interests:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            interests_embs <span class="op">=</span> np.vstack(<span class="bu">list</span>(user.interests.values()))</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            interest_event_max_sims <span class="op">=</span> np.<span class="bu">max</span>(interests_embs <span class="op">@</span> <span class="va">self</span>.event_embs.T, axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(interest_event_max_sims.shape)</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># How good relevant events are (user behavior + interests, higher better)</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        event_scores <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> <span class="va">self</span>.interest_weight) <span class="op">*</span> usr_event_sims <span class="op">+</span> <span class="va">self</span>.interest_weight <span class="op">*</span> interest_event_max_sims</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(event_scores.shape)</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Deduplicate</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        n_events <span class="op">=</span> usr_event_sims.shape[<span class="dv">0</span>]</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_events):</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, n_events):</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> event_event_sims[i, j] <span class="op">&gt;</span> <span class="va">self</span>.dedup_threshold:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># We remove the later event (j &gt; i)</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                    event_scores[j] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># print('removed ',j, 'too similar to ',i)</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MMR</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        selected <span class="op">=</span> [event_scores.argmax()]</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            mmr_scores <span class="op">=</span> {}</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> e_ix <span class="kw">in</span> <span class="bu">range</span>(n_events):</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> e_ix <span class="kw">in</span> selected: <span class="cf">continue</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                lamb <span class="op">=</span> <span class="va">self</span>.mmr_relevance_lambda</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                relevance <span class="op">=</span> event_scores[e_ix]</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                max_sim_to_selected <span class="op">=</span> <span class="bu">max</span>([event_event_sims[e_ix, s] <span class="cf">for</span> s <span class="kw">in</span> selected])</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                mmr_score <span class="op">=</span> lamb <span class="op">*</span> relevance <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> lamb) <span class="op">*</span> <span class="op">-</span>max_sim_to_selected</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                mmr_scores[e_ix] <span class="op">=</span> mmr_score</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>            selected.append(<span class="bu">max</span>(mmr_scores, key <span class="op">=</span> mmr_scores.get))</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(selected)</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="va">self</span>.events[i] <span class="cf">for</span> i <span class="kw">in</span> selected]</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> record_feedback(<span class="va">self</span>, usr, event_id, rating):</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update usr_emb with weighted EMA</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> {<span class="st">'up'</span>: <span class="fl">1.</span>, <span class="st">'down'</span>: <span class="op">-</span><span class="fl">1.</span>, <span class="st">'cal'</span>: <span class="fl">2.</span>}[rating]</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        event_emb <span class="op">=</span> <span class="va">self</span>.event_embs[event_id]</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="va">self</span>.vote_EMA_alpha</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        usr.usr_emb <span class="op">=</span> alpha <span class="op">*</span> usr.usr_emb <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> w <span class="op">*</span> event_emb</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        usr.usr_emb <span class="op">/=</span> np.linalg.norm(usr.usr_emb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="ec479049" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check: should get recommended similar events to an event if we init usr_emb with it</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> Recommender(events, E, vote_EMA_alpha <span class="op">=</span> <span class="fl">0.1</span>, interest_weight <span class="op">=</span> <span class="fl">0.7</span>, mmr_relevance_lambda <span class="op">=</span> <span class="fl">0.25</span>, dedup_threshold <span class="op">=</span> <span class="fl">0.99</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print(stringify_event(events[ix]))</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>usr <span class="op">=</span> User(<span class="dv">0</span>)<span class="co">#, init_usr_emb_fn=lambda: E[ix])</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>usr.add_interests([<span class="st">'music'</span>, <span class="st">'statistics'</span>, <span class="st">'computers'</span>])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> e <span class="kw">in</span> r.recommend(usr, <span class="dv">10</span>):</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'='</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(stringify_event(e))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[274, 3, 132, 25, 112, 291, 657, 12, 344, 585]
==================================================
Lecture / Discussion:MPSDS JPSM Seminar Series - Statistics is a Core Competency for Sound Health Policy: Madhumita (Bonnie) Ghosh-Dastidar - Rand
MPSDS JPSM Seminar Series
March 12, 2025
12:00-1:00 pm EDT

In person, Room G300 Perry Building, and via Zoom.
The Zoom call will be locked 10 minutes after the start of the presentation. 

Statistics is a Core Competency for Sound Health Policy 

The American Statistical Association vision imagines a world that relies on data and statistical thinking to drive discovery and inform decisions.  We know the challenges to attaining this vision are significant, so collaboration is key.  As a statistician working to inform policy and decision making, I know it will take collaboration across disciplines to address society’s biggest challenges—e.g., pandemic recovery, climate change, precision medicine, education reform, or criminal justice. In an era of data ubiquity and rapid analysi...
Where:Perry Building
When:Wednesday 12
Sponsors:Michigan Program in Survey and Data Science, Institute for Social Research, Survey Research Center
==================================================
Other:Spring Break
Lets go rowing
Where:Gainesville, GA
When:Sunday 00
Sponsors:Maize Pages Student Organizations, Men's Rowing
==================================================
Exercise / Fitness:Strength, Stretch and Balance
Lifetime Fitness classes are offered at Briarwood Mall in the JCPenney wing. No experience necessary. Classes are specifically designed for older adults, however, everyone is welcome. LTF classes are free, however, please consider making a $2/person per class donation as our classes are funded strictly through donations. No registration is necessary, simply attend when it fits your schedule.This class is open to everyone. The goal of this class is to work on your strength, flexibility, and balance in order to improve fitness levels and the ease of everyday tasks.
Where:100 Briarwood Circle
When:Tuesday 09
Sponsors:Kinesiology Community Programs
==================================================
Exhibition:Sky Tonight
A live presentation on what to find in the sky tonight and for the coming few weeks. This presentation includes how to find the cardinal directions with the North Star, current and upcoming constellations, visible planets, a few deep sky objects depending on the season, and other interesting astronomical visualizations. If you want to be able to look up from your own backyard and know what to look for, this is the show for you.
Where:Museum of Natural History
When:Sunday 13
Sponsors:Planetarium &amp; Dome Theater at the Museum of Natural History
==================================================
Performance:Jiani Wu, piano
Graduate student Jiani Wu performs a recital.
Where:Earl V. Moore Building
When:Monday 19
Sponsors:School of Music, Theatre &amp; Dance
==================================================
Careers / Jobs:A Recruiter's Perspective on Updating Your LinkedIn Profile (Virtual)
Whether you're a recent graduate, a seasoned professional, or a&nbsp;member of the military looking for your&nbsp;new&nbsp;career, ourtraining session is designed for you.&nbsp;Learn the latest tips and strategies to enhance your LinkedIn profile, attract recruiters,and network effectively. This virtual event gives insight on what recruiters are looking for when reviewing your LinkedIn Profile. It also answers questions about networking via LinkedIn and how to maximize your page.&nbsp;Don't miss this opportunity to boost your online presence and take your career to the next level!
Where:
When:Wednesday 14
Sponsors:University Career Center
==================================================
Film Screening:Korean Cinema NOW | Road to Boston | 1947 보스톤: 2023 ‧ Drama  ‧ 1h 48m ‧ Rated PG-13
View the trailer at: https://www.youtube.com/watch?v=_K4B9w0FLBk

"If the country gained independence, our records should naturally become independent too!" 

In the 1936 Berlin Olympics, marathon gold medalist Son Ki-jeong set a world record. On the podium, as the Japanese national anthem "Kimigayo" played, he covered the Japanese flag on his chest with a potted plant, making him an instant national hero. However, due to Japanese oppression, he could no longer run. After Korea's liberation, in Seoul in 1947, Son Ki-jeong approaches Seo Yoon-bok, a promising marathon runner considered the next Son Ki-jeong, with an unexpected proposal to compete in the Boston Marathon. He suggests running to reclaim the glory of the Berlin Olympics that had been attributed to Japan, this time with t...
Where:State Theater (233 S State St, Ann Arbor)
When:Saturday 13
Sponsors:Nam Center for Korean Studies, International Institute, Asian Languages and Cultures
==================================================
Exhibition:The Bibliophile and the Library: Private-Press Books from the Collection of Bill Heidrich
View beautifully illustrated books that stand as remarkable testaments to the work of twentieth-century small private presses, which, in contrast to the trend of mass commercialization, produced limited editions that celebrated the uniqueness of manual craftsmanship. Features such as exquisite typeface design, letterpress printing, handmade paper, traditional illustration techniques like woodcut and engraving, and the inclusion of original art by renowned artists highlight the presses' dedication to artistry and detail.

The display opens with an edition of "The Works of Geoffrey Chaucer," published in 1896 by William Morris at his Kelmscott Press, a pivotal press that greatly influenced the development of the private press movement as a means of preserving and revitalizing the fine p...
Where:Hatcher Graduate Library
When:Sunday 09
Sponsors:University Library
==================================================
Social / Informal Gathering:Deutschtisch im Max Kade Haus
Deutschtisch is a weekly event in the North Quad dining hall for Max Kade residents and visitors from outside of Max Kade Haus to speak German during a meal.
Where:North Quad
When:Wednesday 18
Sponsors:Germanic Languages &amp; Literatures, Max Kade German Residence
==================================================
Workshop / Seminar:Preprint Algebraic Geometry Seminar: Flat pushforwards of Chern classes and the smoothability of cycles below the middle dimension, after Kollár and Voisin: Hyunsuk Kim (UM)
https://arxiv.org/abs/2311.04714
Where:East Hall
When:Friday 16
Sponsors:Preprint Algebraic Geometry Seminar - Department of Mathematics, Department of Mathematics</code></pre>
</div>
</div>
</section>
<section id="tuning" class="level1">
<h1>Tuning</h1>
<div id="32a68b0c" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>The prompts</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> <span class="kw">lambda</span> persona_str, n_weeks: <span class="ss">f'''</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ss">Asume the following persona and use it to answer all of the following questions.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ss">Persona:</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>persona_str<span class="sc">}</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ss">You will help evaluate a recommender system for events. You will be given a list of </span><span class="sc">{</span>n_weeks<span class="sc">}</span><span class="ss"> events each "week" and asked to rate them.</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weekly_prompt(recommended_events):</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  formated_events <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join([<span class="ss">f"---</span><span class="ch">\n</span><span class="ss">Event </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">+</span> stringify_event(e, <span class="dv">200</span>) <span class="cf">for</span> i,e <span class="kw">in</span> <span class="bu">enumerate</span>(recommended_events)])</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="ss">f'''Here are the events for this week:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="sc">{</span>formated_events<span class="sc">}</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="ss">  For each event, provide a "vote":</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="ss">  - "up" if you are interested in the event and would consider attending</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="ss">  - "cal" if you would actively try to add it to your calendar and attend</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="ss">  - "down" if you are not interested and would not attend</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="ss">  - "neutral" if you are indifferent and have no strong opinion</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  Additionally, rate these weekly recommendations as a whole on a scale of 1-10, where:</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  - 1 = "Completely dissatisfied; none of these events appeal to me"</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  - 5 = "Neutral; some events are okay, but the list isn't exciting"</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="ss">  - 10 = "Extremely satisfied; most or all events are highly appealing"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="ss">  Consider factors like how well the events match your (persona's) interests, the variety, and overall excitement.</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="ss">  Return your ratings in JSON format, for example:</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="ch">{{</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    "event_ratings": [</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="ss">      </span><span class="ch">{{</span><span class="ss">"event_id": 0, "vote": "down/neutral/up/cal"</span><span class="ch">}}</span><span class="ss">,</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="ss">      </span><span class="ch">{{</span><span class="ss">"event_id": 1, "vote": "down/neutral/up/cal"</span><span class="ch">}}</span><span class="ss">,</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="ss">      ...</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    ],</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="ss">    "weekly_satisfaction": ?</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="ch">}}</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="ss">  '''</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8fba00bf" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eval_recomender(persona_json, persona_str, vote_EMA_alpha, interest_weight, mmr_relevance_lambda, dedup_threshold, n_recommendations):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Form user</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    usr <span class="op">=</span> User(<span class="dv">0</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">'interests'</span> <span class="kw">in</span> persona_json, <span class="st">'No interests in persona: '</span> <span class="op">+</span> persona_json</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    usr.add_interests(persona_json[<span class="st">'interests'</span>])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    evaluations <span class="op">=</span> []</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate multiple weeks</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, week_str <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">sorted</span>(os.listdir(<span class="st">'data/semester_data'</span>))):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load week data</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'data/semester_data/</span><span class="sc">{</span>week_str<span class="sc">}</span><span class="ss">/events.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f: week_events <span class="op">=</span> json.load(f)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        week_embs <span class="op">=</span> np.load(<span class="ss">f'data/semester_data/</span><span class="sc">{</span>week_str<span class="sc">}</span><span class="ss">/embs.npy'</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get recommendations for that week</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\t</span><span class="ss">week: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">, # events: </span><span class="sc">{</span><span class="bu">len</span>(week_events)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> Recommender(week_events, week_embs, vote_EMA_alpha, interest_weight, mmr_relevance_lambda, dedup_threshold)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        recommended_events <span class="op">=</span> r.recommend(usr, n_recommendations)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ask Gemini to evaluate</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> genai.Client(api_key <span class="op">=</span> os.environ.get(<span class="st">'GEMINI_API_KEY'</span>))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> <span class="st">'gemini-2.0-flash-lite'</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        contents <span class="op">=</span> [types.Content(role <span class="op">=</span> <span class="st">'user'</span>, parts <span class="op">=</span> [types.Part.from_text(text <span class="op">=</span> weekly_prompt(recommended_events))])]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        gen_config <span class="op">=</span> types.GenerateContentConfig(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            temperature <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            top_p <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            top_k <span class="op">=</span> <span class="dv">40</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            max_output_tokens <span class="op">=</span> <span class="dv">8192</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            response_mime_type <span class="op">=</span> <span class="st">'application/json'</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            system_instruction <span class="op">=</span> [types.Part.from_text(text <span class="op">=</span> system_prompt(persona_str, n_recommendations))],</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.models.generate_content(model <span class="op">=</span> model, contents <span class="op">=</span> contents, config <span class="op">=</span> gen_config)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        evaluation <span class="op">=</span> json.loads(response.text)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Record feedback</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rating <span class="kw">in</span> evaluation[<span class="st">'event_ratings'</span>]:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> rating[<span class="st">'vote'</span>] <span class="kw">in</span> [<span class="st">'up'</span>, <span class="st">'down'</span>, <span class="st">'cal'</span>]:</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                r.record_feedback(usr, rating[<span class="st">'event_id'</span>], rating[<span class="st">'vote'</span>])</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> rating[<span class="st">'vote'</span>] <span class="op">!=</span> <span class="st">'neutral'</span>: <span class="bu">print</span>(<span class="st">'Invalid vote:'</span>, rating)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        evaluation[<span class="st">'week'</span>] <span class="op">=</span> i</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        evaluations.append(evaluation)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> evaluations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="844fcaef" class="cell" data-execution_count="70">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b6b91668" class="cell" data-execution_count="71">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>n_recommendations <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dedup_threshold <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>n_personas <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'data/personas.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f: personas <span class="op">=</span> json.load(f)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># random.shuffle(personas)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> []</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i_p, persona_json <span class="kw">in</span> <span class="bu">enumerate</span>(personas[:n_personas]):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    persona_str <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join([<span class="ss">f'- </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> k, v <span class="kw">in</span> persona_json.items()])</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Persona </span><span class="sc">{</span>i_p<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_personas<span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="sc">{</span>persona_str<span class="sc">}</span><span class="ss">'</span>)    </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (vote_EMA_alpha, interest_weight, mmr_relevance_lambda) <span class="kw">in</span> <span class="bu">enumerate</span>(product(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.75</span>, <span class="fl">0.8</span>, <span class="fl">0.85</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>],</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        np.linspace(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="dv">5</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        np.linspace(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="dv">5</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        )):</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="dv">6</span><span class="op">*</span><span class="dv">5</span><span class="op">*</span><span class="dv">5</span><span class="sc">}</span><span class="ss">'</span>, vote_EMA_alpha, interest_weight, mmr_relevance_lambda)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        evaluations <span class="op">=</span> eval_recomender(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            persona_json, persona_str, vote_EMA_alpha, interest_weight,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            mmr_relevance_lambda, dedup_threshold, n_recommendations</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> evaluation <span class="kw">in</span> evaluations:</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            df.append({</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'week'</span>: evaluation[<span class="st">'week'</span>],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">'persona_id'</span>: i_p,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">'persona'</span>: persona_json,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">'vote_EMA_alpha'</span>: vote_EMA_alpha,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">'interest_weight'</span>: interest_weight,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'mmr_relevance_lambda'</span>: mmr_relevance_lambda,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">'weekly_satisfaction'</span>: evaluation[<span class="st">'weekly_satisfaction'</span>],</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">**</span>{d[<span class="st">'event_id'</span>]:d[<span class="st">'vote'</span>] <span class="cf">for</span> d <span class="kw">in</span> evaluation[<span class="st">'event_ratings'</span>]}</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(df)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    df.to_csv(<span class="st">'data/evaluations.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Persona 1/10:
- name: Aisha Khan
- age: 20
- gender: Female
- ethnicity: Pakistani-American
- hometown: Chicago, Illinois
- level: Undergraduate
- year: Junior
- major: Computer Science
- type of school: Public University
- backstory: Aisha, the first in her family to attend college, feels a significant responsibility to succeed. Witnessing her parents' sacrifices instilled in her a strong work ethic, however, she sometimes struggles to balance her demanding coursework with her role as a caregiver for her younger siblings. Despite these challenges, she excels in her coding projects and finds solace in building tech communities for underrepresented minorities.
- interests: ['Cybersecurity, especially ethical hacking', 'Playing competitive online games', 'Pakistani and Bollywood films']
- short-term goal: Successfully complete a challenging software engineering project by the end of the semester.
0 / 150 0.75 0.1 0.1
    week: 0, # events: 509
    week: 1, # events: 570
    week: 2, # events: 551
    week: 3, # events: 560
    week: 4, # events: 538
    week: 5, # events: 519
    week: 6, # events: 594
    week: 7, # events: 511
    week: 8, # events: 528
    week: 9, # events: 623
    week: 10, # events: 561
    week: 11, # events: 202
    week: 12, # events: 501
    week: 13, # events: 351
    week: 14, # events: 160
    week: 15, # events: 62</code></pre>
</div>
</div>
<div id="b4430293" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="56">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">week</th>
<th data-quarto-table-cell-role="th">persona_id</th>
<th data-quarto-table-cell-role="th">persona</th>
<th data-quarto-table-cell-role="th">vote_EMA_alpha</th>
<th data-quarto-table-cell-role="th">interest_weight</th>
<th data-quarto-table-cell-role="th">mmr_relevance_lambda</th>
<th data-quarto-table-cell-role="th">weekly_satisfaction</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>{'name': 'Jackson Miller', 'age': 28, 'gender'...</td>
<td>0.75</td>
<td>0.1</td>
<td>0.1</td>
<td>4</td>
<td>neutral</td>
<td>down</td>
<td>up</td>
<td>down</td>
<td>down</td>
<td>down</td>
<td>down</td>
<td>down</td>
<td>down</td>
<td>cal</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="76b270f4" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> alpha_analysis(alpha, n_up, n_down, n_weeks, seed):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set seed</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> Recommender(events, E, alpha)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    usr <span class="op">=</span> User(<span class="dv">0</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> [{</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># What events we up/down vote each week</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'up'</span>: random.sample(<span class="bu">range</span>(<span class="bu">len</span>(events)), n_up),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'down'</span>: random.sample(<span class="bu">range</span>(<span class="bu">len</span>(events)), n_down),</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'up avg. rank'</span>: {}, <span class="co"># judging week -&gt; avg rank</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'down avg. rank'</span>: {},</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">for</span> week <span class="kw">in</span> <span class="bu">range</span>(n_weeks)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> w_i, week_data <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Choose n_up random events to upvote, n_down to downvote, and randomize the order in which we vote</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        up_events <span class="op">=</span> week_data[<span class="st">'up'</span>]</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        down_events <span class="op">=</span> week_data[<span class="st">'down'</span>]</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        voted <span class="op">=</span> up_events <span class="op">+</span> down_events</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        random.shuffle(voted)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> voted:</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            rating <span class="op">=</span> <span class="st">'up'</span> <span class="cf">if</span> i <span class="kw">in</span> up_events <span class="cf">else</span> <span class="st">'down'</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>            r.record_feedback(usr, i, rating)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        sims <span class="op">=</span> (usr.usr_emb[<span class="va">None</span>, :] <span class="op">@</span> E.T).flatten()</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all ranks at once (more efficient)</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        sorted_indices <span class="op">=</span> np.argsort(sims)[::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># descending order</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        ranks <span class="op">=</span> {idx: rank <span class="cf">for</span> rank, idx <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_indices)}</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log info for all preceding weeks</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> w_j, w_data <span class="kw">in</span> <span class="bu">enumerate</span>(data[:w_i<span class="op">+</span><span class="dv">1</span>]):</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> evs, field <span class="kw">in</span> <span class="bu">zip</span>([w_data[<span class="st">'up'</span>], w_data[<span class="st">'down'</span>]], [<span class="st">'up avg. rank'</span>, <span class="st">'down avg. rank'</span>]):</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                avg_rank <span class="op">=</span> np.mean([ranks[e] <span class="cf">for</span> e <span class="kw">in</span> evs])</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                w_data[field][w_i] <span class="op">=</span> avg_rank</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    dists_from_best <span class="op">=</span> []</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> []</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> week_data <span class="kw">in</span> data:</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> vote <span class="kw">in</span> [<span class="st">'up'</span>, <span class="st">'down'</span>]:</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            rank_path <span class="op">=</span> np.array(<span class="bu">list</span>(week_data[<span class="ss">f'</span><span class="sc">{</span>vote<span class="sc">}</span><span class="ss"> avg. rank'</span>].values()))</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            dist_from_best <span class="op">=</span> np.<span class="bu">abs</span>(rank_path <span class="op">-</span> <span class="dv">0</span> <span class="cf">if</span> vote <span class="op">==</span> <span class="st">'up'</span> <span class="cf">else</span> <span class="bu">len</span>(events))</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            std <span class="op">=</span> np.std(rank_path)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            dists_from_best.append(np.mean(dist_from_best)) <span class="co"># average distance from best for this path</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>            stds.append(std)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(dists_from_best), np.mean(stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="25197cdf" class="cell" data-execution_count="408">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alphas 0, 0.1, ..., 1</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> np.concatenate([np.linspace(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">6</span>), np.linspace(<span class="fl">0.6</span>, <span class="fl">0.9</span>, <span class="dv">7</span>), np.linspace(<span class="fl">0.91</span>, <span class="fl">1.0</span>, <span class="dv">10</span>)])</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    mean_dists, mean_stds <span class="op">=</span> [], []</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> seed <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        mean_dist_from_best, mean_std <span class="op">=</span> alpha_analysis(alpha, <span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">20</span>, seed)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        mean_dists.append(mean_dist_from_best)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        mean_stds.append(mean_std)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    mean_dist_from_best, mean_std <span class="op">=</span> np.mean(mean_dists), np.mean(mean_stds)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    plt.text(mean_dist_from_best, mean_std, <span class="ss">f'</span><span class="sc">{</span>alpha<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    plt.scatter(mean_dist_from_best, mean_std)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alpha, alpha_analysis(alpha, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">0</span>))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Mean distance from best'</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean std'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0.0 (525.3817919581923, 54.312783190192405)
0.1 (524.7565810337861, 54.40225715660267)
0.2 (523.8998929054262, 54.31565365698141)
0.30000000000000004 (523.22627572986, 54.921965332168554)
0.4 (522.0197097982534, 56.9794133329025)
0.5 (517.920334323743, 63.83384846773788)
0.6 (510.77933021982096, 76.76949824317037)
0.65 (505.1734862030814, 82.91906707881091)
0.7 (497.86132063505374, 86.16086130606831)
0.75 (489.63047914320157, 83.28806251339601)
0.8 (480.96097333611095, 74.1379805811321)
0.8500000000000001 (472.4797047921441, 57.73146208392848)
0.9 (468.83150753203836, 40.70336615649343)
0.91 (468.96931998185426, 37.72783321376087)
0.92 (469.2937768535859, 34.96153355536315)
0.93 (469.94660746600965, 31.983098978180283)
0.9400000000000001 (470.9774236244384, 29.232513648301023)
0.9500000000000001 (472.51639232638064, 26.610025350388753)
0.96 (474.89242325752383, 23.422398635767543)
0.97 (478.74227399026415, 19.704579402033552)
0.98 (485.25596851188027, 14.778369606469013)
0.99 (496.77372423012565, 8.583286643183998)
1.0 (515.9275, 2.1316282072803006e-14)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="408">
<pre><code>Text(0, 0.5, 'Mean std')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1fa7f42e" class="cell" data-execution_count="411">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alphas 0, 0.1, ..., 1</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> np.concatenate([np.linspace(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">6</span>), np.linspace(<span class="fl">0.6</span>, <span class="fl">0.9</span>, <span class="dv">7</span>), np.linspace(<span class="fl">0.91</span>, <span class="fl">1.0</span>, <span class="dv">10</span>)])</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    mean_dists, mean_stds <span class="op">=</span> [], []</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> seed <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        mean_dist_from_best, mean_std <span class="op">=</span> alpha_analysis(alpha, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">20</span>, seed)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        mean_dists.append(mean_dist_from_best)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        mean_stds.append(mean_std)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    mean_dist_from_best, mean_std <span class="op">=</span> np.mean(mean_dists), np.mean(mean_stds)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    plt.text(mean_dist_from_best, mean_std, <span class="ss">f'</span><span class="sc">{</span>alpha<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    plt.scatter(mean_dist_from_best, mean_std)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alpha, alpha_analysis(alpha, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">0</span>))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Mean distance from best'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean std'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0.0 (525.3817919581923, 54.312783190192405)
0.1 (524.7565810337861, 54.40225715660267)
0.2 (523.8998929054262, 54.31565365698141)
0.30000000000000004 (523.22627572986, 54.921965332168554)
0.4 (522.0197097982534, 56.9794133329025)
0.5 (517.920334323743, 63.83384846773788)
0.6 (510.77933021982096, 76.76949824317037)
0.65 (505.1734862030814, 82.91906707881091)
0.7 (497.86132063505374, 86.16086130606831)
0.75 (489.63047914320157, 83.28806251339601)
0.8 (480.96097333611095, 74.1379805811321)
0.8500000000000001 (472.4797047921441, 57.73146208392848)
0.9 (468.83150753203836, 40.70336615649343)
0.91 (468.96931998185426, 37.72783321376087)
0.92 (469.2937768535859, 34.96153355536315)
0.93 (469.94660746600965, 31.983098978180283)
0.9400000000000001 (470.9774236244384, 29.232513648301023)
0.9500000000000001 (472.51639232638064, 26.610025350388753)
0.96 (474.89242325752383, 23.422398635767543)
0.97 (478.74227399026415, 19.704579402033552)
0.98 (485.25596851188027, 14.778369606469013)
0.99 (496.77372423012565, 8.583286643183998)
1.0 (515.9275, 2.1316282072803006e-14)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="411">
<pre><code>Text(0, 0.5, 'Mean std')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-17-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5020d9e9" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sim_analysis(alpha, n_weeks, seed):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set seed</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> Recommender(events, E, alpha <span class="op">=</span> alpha) <span class="co"># 1.0 is never changing usr_emb, 0.0 is always changing</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    usr <span class="op">=</span> User(<span class="dv">0</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    n_weeks <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    events_to_rank_paths <span class="op">=</span> {}</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    events_to_sim_paths <span class="op">=</span> {}</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    events_to_vote_type <span class="op">=</span> {}</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    shuffled_events <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(events)))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    random.shuffle(shuffled_events)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t, event_ix <span class="kw">in</span> <span class="bu">enumerate</span>(shuffled_events[:n_weeks]):</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># choose random vote</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        vote <span class="op">=</span> random.choice([<span class="st">'up'</span>, <span class="st">'down'</span>])</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        events_to_vote_type[event_ix] <span class="op">=</span> vote</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># record feedback</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        r.record_feedback(usr, event_ix, vote)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        sims <span class="op">=</span> (usr.usr_emb[<span class="va">None</span>, :] <span class="op">@</span> E.T).flatten()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all ranks at once (more efficient)</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        sorted_indices <span class="op">=</span> np.argsort(sims)[::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># descending order</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        ranks <span class="op">=</span> {idx: rank <span class="cf">for</span> rank, idx <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_indices)}</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        events_to_rank_paths[event_ix] <span class="op">=</span> []</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        events_to_sim_paths[event_ix] <span class="op">=</span> []</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get rank of event_ix</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e_ix <span class="kw">in</span> events_to_rank_paths:</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>            events_to_rank_paths[e_ix].append(ranks[e_ix])</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            events_to_sim_paths[e_ix].append(sims[e_ix])</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> events_to_rank_paths, events_to_sim_paths, events_to_vote_type, shuffled_events</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>n_weeks <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>events_to_rank_paths, events_to_sim_paths, events_to_vote_type, shuffled_events <span class="op">=</span> sim_analysis(<span class="fl">0.6</span>, n_weeks, <span class="dv">0</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>mean_dev_from_best <span class="op">=</span> []</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event_ix <span class="kw">in</span> events_to_rank_paths:</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    sim_path <span class="op">=</span> events_to_sim_paths[event_ix]</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    rank_path <span class="op">=</span> events_to_rank_paths[event_ix]</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    vote <span class="op">=</span> events_to_vote_type[event_ix]</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    best_rank <span class="op">=</span> <span class="dv">0</span> <span class="cf">if</span> vote <span class="op">==</span> <span class="st">'up'</span> <span class="cf">else</span> <span class="bu">len</span>(events)</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dev_from_best = np.abs(rank_path - best_rank)</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean_dev_from_best.append(np.mean(dev_from_best))</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.arange(shuffled_events.index(event_ix), n_weeks)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    plt.plot(t, sim_path, label <span class="op">=</span> vote, alpha <span class="op">=</span> <span class="fl">0.3</span>, color <span class="op">=</span> <span class="st">'blue'</span> <span class="cf">if</span> vote <span class="op">==</span> <span class="st">'up'</span> <span class="cf">else</span> <span class="st">'red'</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.plot(t, rank_path, label = vote, alpha = 0.3, color = 'blue' if vote == 'up' else 'red')</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'up'</span>, <span class="st">'down'</span>])</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time'</span>)</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.ylabel('Rank')</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Cos. sim with user embedding'</span>)</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Rank of events voted on'</span>)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="17740618" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>n_weeks <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> []</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">41</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(alphas)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> seed <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        events_to_rank_paths, events_to_sim_paths, events_to_vote_type, shuffled_events <span class="op">=</span> sim_analysis(alpha, n_weeks, seed <span class="op">=</span> seed)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        up_last_sims <span class="op">=</span> [events_to_sim_paths[e][<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> e <span class="kw">in</span> events_to_rank_paths <span class="cf">if</span> events_to_vote_type[e] <span class="op">==</span> <span class="st">'up'</span>]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        down_last_sims <span class="op">=</span> [events_to_sim_paths[e][<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> e <span class="kw">in</span> events_to_rank_paths <span class="cf">if</span> events_to_vote_type[e] <span class="op">==</span> <span class="st">'down'</span>]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        up_last_sims <span class="op">=</span> np.array(up_last_sims)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        down_last_sims <span class="op">=</span> np.array(down_last_sims)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        hard_margin <span class="op">=</span> <span class="bu">max</span>((up_last_sims <span class="op">&lt;</span> <span class="bu">max</span>(down_last_sims)).mean(), (down_last_sims <span class="op">&gt;</span> <span class="bu">min</span>(up_last_sims)).mean()) <span class="co">#max(down_last_sims) - min(up_last_sims)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        soft_margin <span class="op">=</span> np.mean(down_last_sims) <span class="op">-</span> np.mean(up_last_sims)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        median_margin <span class="op">=</span> np.median(down_last_sims) <span class="op">-</span> np.median(up_last_sims)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        df.append({</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha'</span>: alpha,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hard_margin'</span>: hard_margin,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'soft_margin'</span>: soft_margin,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_margin'</span>: median_margin,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">'last_up_var'</span>: up_last_sims.var(),</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">'last_down_var'</span>: down_last_sims.var(),</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">'seed'</span>: seed,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alpha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.    0.025 0.05  0.075 0.1   0.125 0.15  0.175 0.2   0.225 0.25  0.275
 0.3   0.325 0.35  0.375 0.4   0.425 0.45  0.475 0.5   0.525 0.55  0.575
 0.6   0.625 0.65  0.675 0.7   0.725 0.75  0.775 0.8   0.825 0.85  0.875
 0.9   0.925 0.95  0.975 1.   ]
0.0
0.025
0.05
0.07500000000000001
0.1
0.125
0.15000000000000002
0.17500000000000002
0.2
0.225
0.25
0.275
0.30000000000000004
0.325
0.35000000000000003
0.375
0.4
0.42500000000000004
0.45
0.47500000000000003
0.5
0.525
0.55
0.5750000000000001
0.6000000000000001
0.625
0.65
0.675
0.7000000000000001
0.7250000000000001
0.75
0.775
0.8
0.8250000000000001
0.8500000000000001
0.875
0.9
0.925
0.9500000000000001
0.9750000000000001
1.0</code></pre>
</div>
</div>
<div id="3e2a4773" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(df)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> df, x <span class="op">=</span> <span class="st">'alpha'</span>, y <span class="op">=</span> <span class="st">'hard_margin'</span>, label <span class="op">=</span> <span class="st">'hard margin'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> df, x <span class="op">=</span> <span class="st">'alpha'</span>, y <span class="op">=</span> <span class="st">'soft_margin'</span>, label <span class="op">=</span> <span class="st">'soft margin'</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> df, x <span class="op">=</span> <span class="st">'alpha'</span>, y <span class="op">=</span> <span class="st">'median_margin'</span>, label <span class="op">=</span> <span class="st">'median margin'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="35608050" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> df.groupby(<span class="st">'alpha'</span>, as_index <span class="op">=</span> <span class="va">False</span>).mean()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha, x, y <span class="kw">in</span> <span class="bu">zip</span>(tmp[<span class="st">'alpha'</span>], tmp[<span class="st">'hard_margin'</span>].to_numpy(), <span class="op">-</span>tmp[<span class="st">'last_up_var'</span>].to_numpy()):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    plt.text(x, y, <span class="ss">f'</span><span class="sc">{</span>alpha<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    plt.scatter(x,y)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Hard margin'</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'- var of last time step'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>Text(0, 0.5, '- var of last time step')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7fe3b070" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> df, x <span class="op">=</span> <span class="st">'alpha'</span>, y <span class="op">=</span> <span class="st">'last_up_var'</span>, label <span class="op">=</span> <span class="st">'last up var'</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> df, x <span class="op">=</span> <span class="st">'alpha'</span>, y <span class="op">=</span> <span class="st">'last_down_var'</span>, label <span class="op">=</span> <span class="st">'last down var'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6c39849c" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>up_last_sims <span class="op">=</span> [events_to_sim_paths[e][<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> e <span class="kw">in</span> events_to_rank_paths <span class="cf">if</span> events_to_vote_type[e] <span class="op">==</span> <span class="st">'up'</span>]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>down_last_sims <span class="op">=</span> [events_to_sim_paths[e][<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> e <span class="kw">in</span> events_to_rank_paths <span class="cf">if</span> events_to_vote_type[e] <span class="op">==</span> <span class="st">'down'</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>up_last_sims <span class="op">=</span> np.array(up_last_sims)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>down_last_sims <span class="op">=</span> np.array(down_last_sims)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.hist(up_last_sims, alpha <span class="op">=</span> <span class="fl">0.5</span>, label <span class="op">=</span> <span class="st">'up'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>plt.hist(down_last_sims, alpha <span class="op">=</span> <span class="fl">0.5</span>, label <span class="op">=</span> <span class="st">'down'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="tuning-1" class="level2">
<h2 class="anchored" data-anchor-id="tuning-1">Tuning</h2>
<div id="975f8df7" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ask chatGPT to take on personas and vote on events </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'data/semester_events.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f: semester_events <span class="op">=</span> json.load(f)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(semester_events)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>7340</code></pre>
</div>
</div>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>Assume we have embedded and clustered the bunch of past events and have the centroids. The basic idea is to fetch the events for the upcoming week Sundays and embed them. We then compute their distances to the centroids (or even the weights) and store them (the NumPy arrays as blobs in the db). And those are the only things we batch.</p>
<p>I drew some inspiration and referenced from karpathy’s <a href="https://github.com/karpathy/arxiv-sanity-lite/tree/master">arxiv-sanity lite</a>. For auth, I decided to go with <a href="https://developers.google.com/identity/gsi/web/guides/overview">Signin With Google</a> as the university is on GSuite. Users can also join a community mailing list to get reminded weekly when recommendations are ready.</p>
<p>The code is openly available <a href="https://github.com/emiliocantuc/wolverine-events">here</a> and site hosted <a href="https://mywolverine.events">here</a>.</p>
</section>
<section id="a-lot-of-room" class="level2">
<h2 class="anchored" data-anchor-id="a-lot-of-room">A lot of room</h2>
<p>for improvement. For example:</p>
<ul>
<li>Once the clusters and centroids are computed, there is no way to change them. Either make sure they are good enough so that we never have to change them or come up with something different.</li>
<li>Find a way to set parameters (learning rate, inv. temperature) in a more principled way, or test thoroughly. Should each user have their own learning rate?</li>
</ul>
<p>And I’m sure I’ll come up with others.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Unfortunatly not all departments / organizations post their events to the main events feed, but finding and maintaining other feeds would be very time consuming.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="../../../">Emilio Cantu-Cervini</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/emiliocantuc/emiliocantuc.github.io/blob/main/posts/others/wolv-events/index.ipynb" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>